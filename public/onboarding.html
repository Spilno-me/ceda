<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - CEDA</title>
    <meta name="description" content="Set up your CEDA preferences by selecting your default organization and project.">
    <link rel="stylesheet" href="/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">CEDA</a>
            <div class="nav-links">
                <a href="#" onclick="CEDA.logout(); return false;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="page">
        <div class="page-content">
            <div class="container">
                <div class="page-header">
                    <h1>Welcome to CEDA</h1>
                    <p>Let's set up your default organization and project for pattern isolation.</p>
                </div>

                <div id="content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading your profile...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>Built by <a href="https://spilno.me" target="_blank">Spilno</a></p>
        </div>
    </footer>

    <script src="/app.js"></script>
    <script>
        let profile = null;
        let currentStep = 1;
        let selectedOrgs = [];
        let primaryOrg = null;
        let selectedRepos = [];
        let repoSearchFilter = '';

        async function init() {
            // Initialize page and check auth
            if (!CEDA.initPage(true)) return;

            const content = document.getElementById('content');

            try {
                // Fetch user profile
                profile = await CEDA.getProfile();
                CEDA.setUser(profile);

                // Check if user already has preferences
                if (profile.preferences) {
                    // Support new multi-org format
                    if (profile.preferences.selectedOrgs) {
                        selectedOrgs = profile.preferences.selectedOrgs;
                        primaryOrg = profile.preferences.primaryOrg || selectedOrgs[0] || null;
                    } else if (profile.preferences.defaultOrg) {
                        // Backward compatibility: treat defaultOrg as both selected and primary
                        selectedOrgs = [profile.preferences.defaultOrg];
                        primaryOrg = profile.preferences.defaultOrg;
                    }
                    selectedRepos = profile.preferences.selectedRepos || [];
                }

                renderOnboarding();
            } catch (error) {
                console.error('Failed to load profile:', error);
                content.innerHTML = `
                    <div class="error-message">
                        Failed to load your profile. Please try logging in again.
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="CEDA.logout()">Login Again</button>
                    </div>
                `;
            }
        }

        function renderOnboarding() {
            const content = document.getElementById('content');
            const orgs = profile.gitIdentity?.organizations || [];

            // Add user's personal account as an option
            const personalOrg = {
                login: profile.githubLogin,
                role: 'owner',
                isPersonal: true
            };

            const allOrgs = [personalOrg, ...orgs];

            content.innerHTML = `
                <div class="user-info">
                    <img class="user-avatar" src="${profile.avatarUrl || `https://github.com/${profile.githubLogin}.png`}" alt="${profile.githubLogin}" onerror="this.style.display='none'">
                    <div class="user-details">
                        <h3>${profile.githubLogin}</h3>
                        <p>${profile.email || 'No email'}</p>
                    </div>
                </div>

                <!-- Step indicator -->
                <div class="step-indicator">
                    <div class="step-indicator-item ${currentStep >= 1 ? 'active' : ''} ${currentStep > 1 ? 'completed' : ''}" data-step="1">
                        <span class="step-indicator-number">1</span>
                        <span class="step-indicator-label">Organization</span>
                    </div>
                    <div class="step-indicator-connector ${currentStep > 1 ? 'active' : ''}"></div>
                    <div class="step-indicator-item ${currentStep >= 2 ? 'active' : ''}" data-step="2">
                        <span class="step-indicator-number">2</span>
                        <span class="step-indicator-label">Repositories</span>
                    </div>
                </div>

                <!-- Step 1: Org Selection -->
                <div class="onboarding-step ${currentStep !== 1 ? 'hidden' : ''}" id="step-org">
                    <div class="section">
                        <h3>Select Organizations</h3>
                        <p>Select organizations Herald should learn from. Mark one as primary for non-git folder context.</p>
                        
                        <div class="org-grid" id="org-grid">
                            ${allOrgs.map(org => `
                                <div class="card card-selectable org-card ${selectedOrgs.includes(org.login) ? 'selected' : ''} ${primaryOrg === org.login ? 'primary' : ''}" 
                                     data-org="${org.login}">
                                    <div class="org-checkbox" onclick="toggleOrgSelection('${org.login}', event)">
                                        <input type="checkbox" 
                                               ${selectedOrgs.includes(org.login) ? 'checked' : ''} 
                                               onclick="toggleOrgSelection('${org.login}', event)">
                                    </div>
                                    <div class="org-primary-star ${selectedOrgs.includes(org.login) ? 'visible' : ''}" 
                                         onclick="setPrimaryOrg('${org.login}', event)"
                                         title="${primaryOrg === org.login ? 'Primary organization' : 'Set as primary'}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="${primaryOrg === org.login ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                                        </svg>
                                    </div>
                                    <div class="org-card-content" onclick="toggleOrgSelection('${org.login}', event)">
                                        <div class="org-avatar">
                                            <img src="https://github.com/${org.login}.png" alt="${org.login}" onerror="this.parentElement.textContent='${CEDA.getInitials(org.login)}'">
                                        </div>
                                        <div class="org-info">
                                            <div class="org-name">${org.login}</div>
                                            <div class="org-role">${org.isPersonal ? 'Personal' : org.role}</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>

                <!-- Step 2: Repo Selection -->
                <div class="onboarding-step ${currentStep !== 2 ? 'hidden' : ''}" id="step-repos">
                    <div class="section">
                        <h3>Select Repositories to Track</h3>
                        <p>Choose which repositories Herald should learn patterns from.</p>

                        <div class="repo-filter">
                            <input type="text" 
                                   class="repo-search-input" 
                                   placeholder="Filter repositories..." 
                                   id="repo-search"
                                   oninput="filterRepos(this.value)">
                        </div>

                        <div class="repo-list" id="repo-list">
                            <!-- Repo checkboxes rendered here -->
                        </div>

                        <div class="repo-actions">
                            <button class="btn btn-secondary btn-sm" onclick="selectAllRepos()">Select All</button>
                            <button class="btn btn-secondary btn-sm" onclick="deselectAllRepos()">Clear</button>
                            <span class="repo-count" id="repo-count">0 selected</span>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="onboarding-nav">
                    <button class="btn btn-secondary" id="btn-back" onclick="goBack()" style="${currentStep === 1 ? 'visibility: hidden;' : ''}">Back</button>
                    <div class="nav-right">
                        <button class="btn btn-secondary" onclick="skipSetup()">Skip for now</button>
                        <button class="btn btn-primary" id="btn-next" onclick="goNext()" ${currentStep === 1 && selectedOrgs.length === 0 ? 'disabled' : ''}>
                            ${currentStep === 2 ? 'Complete Setup' : 'Continue'}
                        </button>
                    </div>
                </div>
            `;

            // If we're on step 2, render the repo list
            if (currentStep === 2) {
                renderRepoList();
            }
        }

        function getReposForOrg(orgLogin) {
            if (!orgLogin || !profile.gitIdentity?.repositories) return [];
            
            return profile.gitIdentity.repositories.filter(repo => {
                const repoOrg = repo.fullName.split('/')[0];
                return repoOrg.toLowerCase() === orgLogin.toLowerCase();
            });
        }

        function getReposForSelectedOrgs() {
            if (selectedOrgs.length === 0 || !profile.gitIdentity?.repositories) return [];
            
            return profile.gitIdentity.repositories.filter(repo => {
                const repoOrg = repo.fullName.split('/')[0].toLowerCase();
                return selectedOrgs.some(org => org.toLowerCase() === repoOrg);
            });
        }

        function renderRepoList() {
            const repos = getReposForSelectedOrgs();
            const container = document.getElementById('repo-list');
            
            // Filter repos based on search
            const filteredRepos = repos.filter(repo => {
                if (!repoSearchFilter) return true;
                const repoName = repo.fullName.split('/')[1].toLowerCase();
                return repoName.includes(repoSearchFilter.toLowerCase());
            });

            if (filteredRepos.length === 0) {
                container.innerHTML = `
                    <div class="repo-empty">
                        ${repos.length === 0 ? 'No repositories found for this organization.' : 'No repositories match your filter.'}
                    </div>
                `;
            } else {
                container.innerHTML = filteredRepos.map(repo => `
                    <label class="repo-item">
                        <input type="checkbox"
                               value="${repo.fullName}"
                               ${selectedRepos.includes(repo.fullName) ? 'checked' : ''}
                               onchange="toggleRepo('${repo.fullName}')">
                        <span class="repo-item-name">${repo.fullName.split('/')[1]}</span>
                        <span class="repo-item-permission">${repo.permission || 'read'}</span>
                    </label>
                `).join('');
            }

            updateRepoCount();
        }

        function filterRepos(value) {
            repoSearchFilter = value;
            renderRepoList();
        }

        function toggleRepo(fullName) {
            if (selectedRepos.includes(fullName)) {
                selectedRepos = selectedRepos.filter(r => r !== fullName);
            } else {
                selectedRepos.push(fullName);
            }
            updateRepoCount();
        }

        function selectAllRepos() {
            const repos = getReposForSelectedOrgs();
            // Filter by search if active
            const filteredRepos = repos.filter(repo => {
                if (!repoSearchFilter) return true;
                const repoName = repo.fullName.split('/')[1].toLowerCase();
                return repoName.includes(repoSearchFilter.toLowerCase());
            });
            
            filteredRepos.forEach(repo => {
                if (!selectedRepos.includes(repo.fullName)) {
                    selectedRepos.push(repo.fullName);
                }
            });
            renderRepoList();
        }

        function deselectAllRepos() {
            const repos = getReposForSelectedOrgs();
            // Only deselect repos that match current filter (or all if no filter)
            const filteredRepos = repos.filter(repo => {
                if (!repoSearchFilter) return true;
                const repoName = repo.fullName.split('/')[1].toLowerCase();
                return repoName.includes(repoSearchFilter.toLowerCase());
            });
            
            const filteredNames = filteredRepos.map(r => r.fullName);
            selectedRepos = selectedRepos.filter(r => !filteredNames.includes(r));
            renderRepoList();
        }

        function updateRepoCount() {
            const countEl = document.getElementById('repo-count');
            if (countEl) {
                countEl.textContent = `${selectedRepos.length} selected`;
            }
        }

        function toggleOrgSelection(orgLogin, event) {
            if (event) {
                event.stopPropagation();
            }
            
            const isCurrentlySelected = selectedOrgs.includes(orgLogin);
            
            if (isCurrentlySelected) {
                // Deselect the org
                selectedOrgs = selectedOrgs.filter(org => org !== orgLogin);
                
                // If this was the primary org, set a new primary
                if (primaryOrg === orgLogin) {
                    primaryOrg = selectedOrgs.length > 0 ? selectedOrgs[0] : null;
                }
                
                // Remove repos from this org from selectedRepos
                selectedRepos = selectedRepos.filter(repo => {
                    const repoOrg = repo.split('/')[0].toLowerCase();
                    return repoOrg !== orgLogin.toLowerCase();
                });
            } else {
                // Select the org
                selectedOrgs.push(orgLogin);
                
                // If this is the first selected org, make it primary
                if (selectedOrgs.length === 1) {
                    primaryOrg = orgLogin;
                }
            }
            
            repoSearchFilter = '';
            renderOnboarding();
        }

        function setPrimaryOrg(orgLogin, event) {
            if (event) {
                event.stopPropagation();
            }
            
            // Can only set primary if org is selected
            if (!selectedOrgs.includes(orgLogin)) {
                return;
            }
            
            primaryOrg = orgLogin;
            renderOnboarding();
        }

        function showStep(step) {
            currentStep = step;
            renderOnboarding();
        }

        function goNext() {
            if (currentStep === 1) {
                if (selectedOrgs.length === 0) {
                    CEDA.showError(document.getElementById('step-org'), 'Please select at least one organization');
                    return;
                }
                if (!primaryOrg) {
                    CEDA.showError(document.getElementById('step-org'), 'Please designate a primary organization');
                    return;
                }
                showStep(2);
            } else if (currentStep === 2) {
                if (selectedRepos.length === 0) {
                    CEDA.showError(document.getElementById('step-repos'), 'Please select at least one repository');
                    return;
                }
                saveAndContinue();
            }
        }

        function goBack() {
            if (currentStep === 2) {
                showStep(1);
            }
        }

        async function saveAndContinue() {
            const btn = document.getElementById('btn-next');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                // Use first selected repo as default project
                const defaultProject = selectedRepos.length > 0 ? selectedRepos[0] : `${primaryOrg}/default`;
                
                await CEDA.updatePreferences({
                    selectedOrgs: selectedOrgs,
                    primaryOrg: primaryOrg,
                    defaultOrg: primaryOrg, // Backward compatibility
                    defaultProject: defaultProject,
                    selectedRepos: selectedRepos,
                });

                // Update local user data
                profile.preferences = {
                    selectedOrgs: selectedOrgs,
                    primaryOrg: primaryOrg,
                    defaultOrg: primaryOrg, // Backward compatibility
                    defaultProject: defaultProject,
                    selectedRepos: selectedRepos,
                };
                CEDA.setUser(profile);

                // Redirect to dashboard
                window.location.href = '/dashboard.html';
            } catch (error) {
                console.error('Failed to save preferences:', error);
                CEDA.showError(document.getElementById('content'), 'Failed to save preferences. Please try again.');
                btn.disabled = false;
                btn.textContent = 'Complete Setup';
            }
        }

        function skipSetup() {
            // Use personal account as default
            const defaultOrg = profile.githubLogin;
            const defaultProject = `${defaultOrg}/default`;

            CEDA.updatePreferences({
                selectedOrgs: [defaultOrg],
                primaryOrg: defaultOrg,
                defaultOrg, // Backward compatibility
                defaultProject,
                selectedRepos: [],
            }).then(() => {
                profile.preferences = { 
                    selectedOrgs: [defaultOrg],
                    primaryOrg: defaultOrg,
                    defaultOrg, // Backward compatibility
                    defaultProject, 
                    selectedRepos: [] 
                };
                CEDA.setUser(profile);
                window.location.href = '/dashboard.html';
            }).catch(error => {
                console.error('Failed to save preferences:', error);
                // Still redirect, preferences will be set on next visit
                window.location.href = '/dashboard.html';
            });
        }

        // Initialize on load
        init();
    </script>
</body>
</html>
