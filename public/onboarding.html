<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - CEDA</title>
    <meta name="description" content="Set up your CEDA preferences and enable repositories for pattern tracking.">
    <link rel="stylesheet" href="/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a href="/" class="logo">CEDA</a>
            <div class="nav-links">
                <a href="#" onclick="CEDA.logout(); return false;">Logout</a>
            </div>
        </div>
    </nav>

    <div class="page">
        <div class="page-content">
            <div class="container">
                <div class="page-header">
                    <h1>Welcome to CEDA</h1>
                    <p>Your patterns aggregate across all your contexts. Enable repos to start learning.</p>
                </div>

                <div id="content">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading your profile...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>Built by <a href="https://spilno.me" target="_blank">Spilno</a></p>
        </div>
    </footer>

    <script src="/app.js"></script>
    <script>
        let profile = null;
        let currentStep = 1;
        let selectedRepos = [];
        let repoSearchFilter = '';
        let expandedOrgs = new Set();

        async function init() {
            if (!CEDA.initPage(true)) return;

            const content = document.getElementById('content');

            try {
                profile = await CEDA.getProfile();
                CEDA.setUser(profile);

                // Load existing preferences
                if (profile.preferences && profile.preferences.selectedRepos) {
                    selectedRepos = profile.preferences.selectedRepos || [];
                }

                renderOnboarding();
            } catch (error) {
                console.error('Failed to load profile:', error);
                content.innerHTML = `
                    <div class="error-message">
                        Failed to load your profile. Please try logging in again.
                    </div>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="CEDA.logout()">Login Again</button>
                    </div>
                `;
            }
        }

        function getAllOrgs() {
            const orgs = profile.gitIdentity?.organizations || [];
            const personalOrg = {
                login: profile.githubLogin,
                role: 'owner',
                isPersonal: true
            };
            return [personalOrg, ...orgs];
        }

        function getReposForOrg(orgLogin) {
            if (!profile.gitIdentity?.repositories) return [];
            return profile.gitIdentity.repositories.filter(repo => {
                const repoOrg = repo.fullName.split('/')[0];
                return repoOrg.toLowerCase() === orgLogin.toLowerCase();
            });
        }

        function renderOnboarding() {
            const content = document.getElementById('content');
            const allOrgs = getAllOrgs();
            const allRepos = profile.gitIdentity?.repositories || [];

            content.innerHTML = `
                <div class="user-info">
                    <img class="user-avatar" src="${profile.avatarUrl || `https://github.com/${profile.githubLogin}.png`}" alt="${profile.githubLogin}" onerror="this.style.display='none'">
                    <div class="user-details">
                        <h3>${profile.githubLogin}</h3>
                        <p>${profile.email || `${profile.githubLogin}@github.local`}</p>
                    </div>
                </div>

                <!-- Step indicator -->
                <div class="step-indicator">
                    <div class="step-indicator-item ${currentStep >= 1 ? 'active' : ''} ${currentStep > 1 ? 'completed' : ''}" data-step="1">
                        <span class="step-indicator-number">1</span>
                        <span class="step-indicator-label">Your Contexts</span>
                    </div>
                    <div class="step-indicator-connector ${currentStep > 1 ? 'active' : ''}"></div>
                    <div class="step-indicator-item ${currentStep >= 2 ? 'active' : ''}" data-step="2">
                        <span class="step-indicator-number">2</span>
                        <span class="step-indicator-label">Enable Repos</span>
                    </div>
                </div>

                <!-- Step 1: Your Contexts (informational) -->
                <div class="onboarding-step ${currentStep !== 1 ? 'hidden' : ''}" id="step-contexts">
                    <div class="section">
                        <h3>Your Pattern Contexts</h3>
                        <p>CEDA aggregates patterns from all your contexts. You are the center.</p>

                        <div class="context-flow">
                            <div class="flow-item">You</div>
                            <div class="flow-arrow">&#8594;</div>
                            <div class="flow-item">Teams</div>
                            <div class="flow-arrow">&#8594;</div>
                            <div class="flow-item">Orgs</div>
                            <div class="flow-arrow">&#8594;</div>
                            <div class="flow-item">Global</div>
                        </div>

                        <div class="org-grid" id="org-grid">
                            ${allOrgs.map(org => {
                                const repoCount = getReposForOrg(org.login).length;
                                return `
                                <div class="card org-card" data-org="${org.login}">
                                    <div class="org-avatar">
                                        <img src="https://github.com/${org.login}.png" alt="${org.login}" onerror="this.parentElement.textContent='${CEDA.getInitials(org.login)}'">
                                    </div>
                                    <div class="org-info">
                                        <div class="org-name">${org.login}</div>
                                        <div class="org-role">${org.isPersonal ? 'Personal' : org.role} &middot; ${repoCount} repos</div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>

                        <p class="context-note">Patterns flow: <strong>user &#8594; team &#8594; org &#8594; orgs &#8594; global</strong></p>
                    </div>
                </div>

                <!-- Step 2: Enable Repos (from ALL orgs) -->
                <div class="onboarding-step ${currentStep !== 2 ? 'hidden' : ''}" id="step-repos">
                    <div class="section">
                        <h3>Enable Repositories</h3>
                        <p>Select which repositories Herald should track for patterns.</p>

                        <div class="repo-filter">
                            <input type="text"
                                   class="repo-search-input"
                                   placeholder="Filter repositories..."
                                   id="repo-search"
                                   oninput="filterRepos(this.value)">
                        </div>

                        <div class="repo-list-grouped" id="repo-list">
                            ${renderGroupedRepoList()}
                        </div>

                        <div class="repo-actions">
                            <button class="btn btn-secondary btn-sm" onclick="selectAllRepos()">Select All</button>
                            <button class="btn btn-secondary btn-sm" onclick="deselectAllRepos()">Clear</button>
                            <span class="repo-count" id="repo-count">${selectedRepos.length} selected</span>
                        </div>
                    </div>
                </div>

                <!-- Navigation -->
                <div class="onboarding-nav">
                    <button class="btn btn-secondary" id="btn-back" onclick="goBack()" style="${currentStep === 1 ? 'visibility: hidden;' : ''}">Back</button>
                    <div class="nav-right">
                        <button class="btn btn-secondary" onclick="skipSetup()">Skip for now</button>
                        <button class="btn btn-primary" id="btn-next" onclick="goNext()">
                            ${currentStep === 2 ? 'Complete Setup' : 'Continue'}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderGroupedRepoList() {
            const allOrgs = getAllOrgs();
            let html = '';

            allOrgs.forEach(org => {
                let repos = getReposForOrg(org.login);

                // Apply filter
                if (repoSearchFilter) {
                    repos = repos.filter(repo => {
                        const repoName = repo.fullName.toLowerCase();
                        return repoName.includes(repoSearchFilter.toLowerCase());
                    });
                }

                if (repos.length === 0 && repoSearchFilter) return;

                const isExpanded = expandedOrgs.has(org.login) || repoSearchFilter;
                const selectedInOrg = repos.filter(r => selectedRepos.includes(r.fullName)).length;

                html += `
                    <div class="repo-org-group">
                        <div class="repo-org-header" onclick="toggleOrgExpand('${org.login}')">
                            <span class="repo-org-toggle">${isExpanded ? '&#9660;' : '&#9654;'}</span>
                            <img class="repo-org-avatar" src="https://github.com/${org.login}.png" alt="${org.login}" onerror="this.style.display='none'">
                            <span class="repo-org-name">${org.login}</span>
                            <span class="repo-org-count">${selectedInOrg}/${repos.length}</span>
                        </div>
                        <div class="repo-org-repos ${isExpanded ? '' : 'collapsed'}">
                            ${repos.length === 0 ? '<div class="repo-empty">No repositories</div>' : repos.map(repo => `
                                <label class="repo-item">
                                    <input type="checkbox"
                                           value="${repo.fullName}"
                                           ${selectedRepos.includes(repo.fullName) ? 'checked' : ''}
                                           onchange="toggleRepo('${repo.fullName}')">
                                    <span class="repo-item-name">${repo.fullName.split('/')[1]}</span>
                                    <span class="repo-item-permission">${repo.permission || 'read'}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            return html || '<div class="repo-empty">No repositories found</div>';
        }

        function toggleOrgExpand(orgLogin) {
            if (expandedOrgs.has(orgLogin)) {
                expandedOrgs.delete(orgLogin);
            } else {
                expandedOrgs.add(orgLogin);
            }
            document.getElementById('repo-list').innerHTML = renderGroupedRepoList();
        }

        function filterRepos(value) {
            repoSearchFilter = value;
            document.getElementById('repo-list').innerHTML = renderGroupedRepoList();
        }

        function toggleRepo(fullName) {
            if (selectedRepos.includes(fullName)) {
                selectedRepos = selectedRepos.filter(r => r !== fullName);
            } else {
                selectedRepos.push(fullName);
            }
            updateRepoCount();
            // Update the grouped list to show correct counts
            document.getElementById('repo-list').innerHTML = renderGroupedRepoList();
        }

        function selectAllRepos() {
            const allRepos = profile.gitIdentity?.repositories || [];
            allRepos.forEach(repo => {
                if (!selectedRepos.includes(repo.fullName)) {
                    // If filtering, only select filtered repos
                    if (repoSearchFilter) {
                        if (repo.fullName.toLowerCase().includes(repoSearchFilter.toLowerCase())) {
                            selectedRepos.push(repo.fullName);
                        }
                    } else {
                        selectedRepos.push(repo.fullName);
                    }
                }
            });
            updateRepoCount();
            document.getElementById('repo-list').innerHTML = renderGroupedRepoList();
        }

        function deselectAllRepos() {
            if (repoSearchFilter) {
                // Only deselect filtered repos
                selectedRepos = selectedRepos.filter(r =>
                    !r.toLowerCase().includes(repoSearchFilter.toLowerCase())
                );
            } else {
                selectedRepos = [];
            }
            updateRepoCount();
            document.getElementById('repo-list').innerHTML = renderGroupedRepoList();
        }

        function updateRepoCount() {
            const countEl = document.getElementById('repo-count');
            if (countEl) {
                countEl.textContent = `${selectedRepos.length} selected`;
            }
        }

        function showStep(step) {
            currentStep = step;
            renderOnboarding();
        }

        function goNext() {
            if (currentStep === 1) {
                showStep(2);
            } else if (currentStep === 2) {
                saveAndContinue();
            }
        }

        function goBack() {
            if (currentStep === 2) {
                showStep(1);
            }
        }

        async function saveAndContinue() {
            const btn = document.getElementById('btn-next');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                // Determine default org from selected repos (most repos wins)
                const orgCounts = {};
                selectedRepos.forEach(repo => {
                    const org = repo.split('/')[0];
                    orgCounts[org] = (orgCounts[org] || 0) + 1;
                });

                const defaultOrg = Object.keys(orgCounts).sort((a, b) => orgCounts[b] - orgCounts[a])[0]
                    || profile.githubLogin;

                const defaultProject = selectedRepos[0] || `${defaultOrg}/default`;

                await CEDA.updatePreferences({
                    defaultOrg: defaultOrg,
                    defaultProject: defaultProject,
                    selectedRepos: selectedRepos,
                });

                profile.preferences = {
                    defaultOrg,
                    defaultProject,
                    selectedRepos,
                };
                CEDA.setUser(profile);

                window.location.href = '/dashboard.html';
            } catch (error) {
                console.error('Failed to save preferences:', error);
                CEDA.showError(document.getElementById('content'), 'Failed to save preferences. Please try again.');
                btn.disabled = false;
                btn.textContent = 'Complete Setup';
            }
        }

        function skipSetup() {
            const defaultOrg = profile.githubLogin;
            const defaultProject = `${defaultOrg}/default`;

            CEDA.updatePreferences({
                defaultOrg,
                defaultProject,
                selectedRepos: [],
            }).then(() => {
                profile.preferences = { defaultOrg, defaultProject, selectedRepos: [] };
                CEDA.setUser(profile);
                window.location.href = '/dashboard.html';
            }).catch(error => {
                console.error('Failed to save preferences:', error);
                window.location.href = '/dashboard.html';
            });
        }

        init();
    </script>

    <style>
        /* Additional styles for grouped repo list */
        .context-flow {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1.5rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .flow-item {
            padding: 0.5rem 1rem;
            background: var(--accent-glow);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 6px;
            color: var(--accent-primary);
            font-weight: 500;
        }

        .flow-item:first-child {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .flow-arrow {
            color: var(--text-muted);
        }

        .context-note {
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 1rem;
        }

        .repo-list-grouped {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            max-height: 400px;
            overflow-y: auto;
        }

        .repo-org-group {
            border-bottom: 1px solid var(--border-color);
        }

        .repo-org-group:last-child {
            border-bottom: none;
        }

        .repo-org-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            background: var(--bg-card);
            transition: background 0.2s;
        }

        .repo-org-header:hover {
            background: var(--bg-secondary);
        }

        .repo-org-toggle {
            color: var(--text-muted);
            font-size: 0.75rem;
            width: 1rem;
        }

        .repo-org-avatar {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        .repo-org-name {
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        .repo-org-count {
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0.25rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        .repo-org-repos {
            border-top: 1px solid var(--border-color);
        }

        .repo-org-repos.collapsed {
            display: none;
        }

        .repo-org-repos .repo-item {
            padding-left: 3rem;
        }
    </style>
</body>
</html>
